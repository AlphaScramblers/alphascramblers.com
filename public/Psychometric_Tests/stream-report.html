<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stream Selection Report</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #eef1f5;
    margin: 0;
  }

  .report-container {
    width: 90%;
    max-width: 900px;
    margin: 40px auto;
    background: #fff;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 5px 22px rgba(0, 0, 0, 0.1);
  }

  h1 {
    text-align: center;
    color: #34495e;
    font-size: 28px;
  }

  .subtitle {
    text-align: center;
    color: #636e72;
    margin-bottom: 25px;
  }

  .score-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }

  .score-card {
    background: #f8f9fc;
    padding: 20px;
    border-radius: 12px;
    border-left: 6px solid #0984e3;
  }

  .score-value {
    font-size: 28px;
    font-weight: 700;
    color: #0984e3;
  }

  .result-box {
    margin-top: 30px;
    padding: 20px;
    text-align: center;
    border-radius: 12px;
    background: #f1f2f6;
    border-left: 8px solid #6c5ce7;
  }

  .tag {
    padding: 8px 16px;
    border-radius: 10px;
    color: #fff;
    font-weight: 600;
  }

  .green { background: #2ecc71; }
  .orange { background: #f39c12; }
  .red { background: #e74c3c; }

  .actions {
    margin-top: 30px;
    text-align: center;
  }

  .retake-btn {
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    background: #0984e3;
    color: #fff;
    cursor: pointer;
  }
</style>
</head>

<body>

<div class="report-container">
  <h1>Stream Selection â€“ Final Report</h1>
  <div class="subtitle">Loading report...</div>

  <div class="score-section">
    <div class="score-card">
      <h3>Behavior</h3>
      <div class="score-value" id="behaviorScore">0</div>
    </div>
    <div class="score-card">
      <h3>Mental</h3>
      <div class="score-value" id="mentalScore">0</div>
    </div>
    <div class="score-card">
      <h3>Aptitude</h3>
      <div class="score-value" id="aptitudeScore">0</div>
    </div>
    <div class="score-card">
      <h3>Total</h3>
      <div class="score-value" id="totalScore">0</div>
    </div>
  </div>

  <div class="result-box">
    <div id="resultMessage"></div>
    <div class="tag" id="resultTag"></div>
  </div>

  <canvas id="pieChart"></canvas>
  <canvas id="barChart"></canvas>

  <div class="actions">
    <button class="retake-btn" id="retakeBtn">Retake Test</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const testId = new URLSearchParams(window.location.search).get("testId");
  if (!testId) return alert("Invalid report");

 const token = localStorage.getItem("token");

    if (!token) {
      alert("Please login again to view your report.");
      window.location.href = "/login.html";
      return;
    }

    const res = await fetch(`/api/stream-report?testId=${testId}`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
  if (!res.ok) {
    alert("Session expired or server error. Please login again.");
    return;
  }

  const data = await res.json();

  if (!data.success) {
    alert("Report not found. Please submit the test first.");
    return;
  }

  const {
    stream,
    aptitudeScore,
    behaviorScore,
    mentalScore,
    totalScore,
    lastGivenAt
  } = data.report;

  document.getElementById("behaviorScore").innerText = behaviorScore;
  document.getElementById("mentalScore").innerText = mentalScore;
  document.getElementById("aptitudeScore").innerText = aptitudeScore;
  document.getElementById("totalScore").innerText = totalScore;

  let tag = document.getElementById("resultTag");
  let msg = document.getElementById("resultMessage");

  if (totalScore <= 40) {
    msg.innerText = "Not suitable for this stream.";
    tag.className = "tag red";
    tag.innerText = "Not Suitable";
  } else if (totalScore <= 70) {
    msg.innerText = "Average suitability.";
    tag.className = "tag orange";
    tag.innerText = "Average";
  } else {
    msg.innerText = "Highly suitable!";
    tag.className = "tag green";
    tag.innerText = "Highly Suitable";
  }

  document.querySelector(".subtitle").innerText =
    `Last given on ${new Date(lastGivenAt).toLocaleDateString("en-IN")}`;

  document.getElementById("retakeBtn").onclick = () => {
    window.location.href = `/Psychometric_Tests/${testId}.html`;
  };
});
</script>

</body>
</html>