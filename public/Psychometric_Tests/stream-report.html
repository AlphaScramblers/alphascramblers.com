<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stream Selection Report</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: #eef1f5;
    margin: 0;
  }

  .report-container {
    width: 90%;
    max-width: 900px;
    margin: 40px auto;
    background: #fff;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 5px 22px rgba(0,0,0,0.1);
  }

  h1 {
    text-align: center;
    color: #34495e;
    font-size: 28px;
  }

  .subtitle {
    text-align: center;
    color: #636e72;
    margin-bottom: 25px;
  }

  .score-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
    gap: 20px;
  }

  .score-card {
    background: #f8f9fc;
    padding: 20px;
    border-radius: 12px;
    border-left: 6px solid #0984e3;
  }

  .score-value {
    font-size: 28px;
    font-weight: 700;
    color: #0984e3;
  }

  .result-box {
    margin-top: 30px;
    padding: 20px;
    text-align: center;
    border-radius: 12px;
    background: #f1f2f6;
    border-left: 8px solid #6c5ce7;
  }

  .tag {
    padding: 8px 16px;
    border-radius: 10px;
    color: #fff;
    font-weight: 600;
    display: inline-block;
    margin-top: 10px;
  }

  .green { background: #2ecc71; }
  .orange { background: #f39c12; }
  .red { background: #e74c3c; }

  canvas {
    margin: 30px auto;
    display: block;
    max-width: 400px;
  }

  .actions {
    margin-top: 30px;
    text-align: center;
  }

  .retake-btn {
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    background: #0984e3;
    color: #fff;
    cursor: pointer;
  }
  #downloadBtn {
  background: #2d3436;
}
#backHomeBtn {
  background: #636e72;
}

</style>
</head>

<body>

<div class="report-container">
  <h1>Stream Selection – Final Report</h1>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <button class="retake-btn" id="backHomeBtn">
      ← Back to Home
    </button>

    <button class="retake-btn" id="downloadBtn">
      Download Report (PDF)
    </button>

  </div>


  <div class="subtitle">Loading report...</div>

  <div class="score-section">
    <div class="score-card">
      <h3>Behavior</h3>
      <div class="score-value" id="behaviorScore">0</div>
    </div>
    <div class="score-card">
      <h3>Mental</h3>
      <div class="score-value" id="mentalScore">0</div>
    </div>
    <div class="score-card">
      <h3>Aptitude</h3>
      <div class="score-value" id="aptitudeScore">0</div>
    </div>
    <div class="score-card">
      <h3>Total</h3>
      <div class="score-value" id="totalScore">0</div>
    </div>
  </div>

  <div class="result-box">
    <div id="resultMessage"></div>
    <div class="tag" id="resultTag"></div>
  </div>

  <canvas id="pieChart"></canvas>
  <canvas id="barChart"></canvas>

  <div class="actions">
    <button class="retake-btn" id="retakeBtn">Retake Test</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const testId = new URLSearchParams(window.location.search).get("testId");
  const token = localStorage.getItem("token");

  if (!testId || !token) {
    alert("Please login again.");
    window.location.href = "/login.html";
    return;
  }

  const res = await fetch(`/api/stream-report?testId=${testId}`, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  const data = await res.json();
  if (!data.success) {
    alert("Report not found");
    return;
  }

  const { stream, scores, totalScore, lastGivenAt } = data.report;

  const behaviorScore = scores.find(s => s.section === "behavior")?.score || 0;
  const mentalScore   = scores.find(s => s.section === "mental")?.score || 0;
  const aptitudeScore = scores.find(s => s.section === "aptitude")?.score || 0;

  document.getElementById("behaviorScore").innerText = behaviorScore;
  document.getElementById("mentalScore").innerText = mentalScore;
  document.getElementById("aptitudeScore").innerText = aptitudeScore;
  document.getElementById("totalScore").innerText = totalScore;

  document.querySelector(".subtitle").innerText =
    `Last given on ${new Date(lastGivenAt).toLocaleDateString("en-IN")}`;

  const msg = document.getElementById("resultMessage");
  const tag = document.getElementById("resultTag");

  if (totalScore <= 40) {
    msg.innerText = "Not suitable for this stream.";
    tag.innerText = "Not Suitable";
    tag.className = "tag red";
  } else if (totalScore <= 70) {
    msg.innerText = "Average suitability.";
    tag.innerText = "Average";
    tag.className = "tag orange";
  } else {
    msg.innerText = "Highly suitable!";
    tag.innerText = "Highly Suitable";
    tag.className = "tag green";
  }

  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: ["Behavior", "Mental", "Aptitude"],
      datasets: [{
        data: [behaviorScore, mentalScore, aptitudeScore],
        backgroundColor: ["#0984e3", "#6c5ce7", "#00b894"]
      }]
    }
  });

  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: ["Behavior", "Mental", "Aptitude"],
      datasets: [{
        label: "Scores",
        data: [behaviorScore, mentalScore, aptitudeScore],
        backgroundColor: ["#74b9ff", "#a29bfe", "#55efc4"],
        borderRadius: 8
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } }
    }
  });

  document.getElementById("retakeBtn").onclick = () => {

  const testFileMap = {
    PCM_test: "PCMpsy.html",
    PCB_test: "PCBpsy.html",
    humanities_test: "humanitiespsy.html",
    withmaths_test: "withmathspsy.html",
    withoutmaths_test: "withoutmathspsy.html"
  };

  const fileName = testFileMap[testId];

  if (!fileName) {
    alert("Test file not found");
    return;
  }

  window.location.href = `/Psychometric_Tests/${fileName}?retake=true`;
};
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
document.getElementById("downloadBtn").onclick = () => {

  const report = document.querySelector(".report-container");

  html2pdf().set({
    margin: 0.5,
    filename: "Stream_Report.pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
  }).from(report).save();

};
</script>
<script>
document.getElementById("backHomeBtn").onclick = () => {
  window.location.href = "/index.html"; // change if your home path is different
};
</script>
</body>
</html>